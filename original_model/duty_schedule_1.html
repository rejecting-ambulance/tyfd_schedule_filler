<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>勤務排表</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      display: flex;
      gap: 20px;
      padding: 20px;
    }
    #schedule-container {
      overflow-x: auto;
    }
    table {
      border-collapse: collapse;
      min-width: 1400px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 6px;
      text-align: center;
      min-width: 80px;
      height: 40px;
    }
    th {
      background: #f0f0f0;
      position: sticky;
      top: 0;
    }
    .droppable {
      background: #f9f9f9;
      vertical-align: top;
    }
    .droppable.highlight {
      border: 2px solid #4CAF50;
      background: #eaffea;
    }

    /* 人員區塊 */
    #personnel {
      width: 400px;
      border: 1px solid #ccc;
      padding: 10px;
    }
    .person-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      grid-template-rows: repeat(15, 1fr);
      gap: 5px;
    }
    .person {
      background: #888;
      color: white;
      padding: 6px;
      text-align: center;
      border-radius: 5px;
      cursor: pointer;
      font-size: 12px;
      user-select: none;
    }
    .person.active {
      background: #4CAF50;
    }

    /* 拖曳卡片 */
    .card {
      background: #007BFF;
      color: white;
      padding: 4px 6px;
      border-radius: 5px;
      cursor: grab;
      font-size: 12px;
      margin: 2px 0;
      display: inline-block;
    }
    .card:active {
      cursor: grabbing;
    }

    button {
      margin-top: 10px;
      padding: 6px 10px;
      background: #007BFF;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    button:hover {
      background: #0056b3;
    }
  </style>
</head>
<body>

  <!-- 勤務排表 -->
  <div id="schedule-container">
    <table id="schedule">
      <thead>
        <tr id="header-row">
          <th>時段</th>
          <th contenteditable="true">勤務A</th>
          <th contenteditable="true">勤務B</th>
          <th contenteditable="true">勤務C</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- 右側：人員清單 -->
  <div id="personnel">
    <h3>人員 (點擊啟用 / 停用)</h3>
    <div class="person-grid" id="personGrid"></div>
    <button id="autoAssign">自動排備勤</button>
  </div>

  <script>
    const schedule = document.getElementById("schedule");
    const headerRow = document.getElementById("header-row");
    const tbody = document.querySelector("#schedule tbody");
    const personGrid = document.getElementById("personGrid");

    // 加上 備1 ~ 備11
    for (let i = 1; i <= 11; i++) {
      let th = document.createElement("th");
      th.textContent = "備" + i;
      headerRow.appendChild(th);
    }

    // 生成時段 (08:00 → 次日 07:00)
    for (let i = 0; i < 24; i++) {
      let hour = (8 + i) % 24;
      let timeLabel = (hour < 10 ? "0" : "") + hour + ":00";
      let tr = document.createElement("tr");

      // 時段欄
      let timeCell = document.createElement("td");
      timeCell.textContent = timeLabel;
      tr.appendChild(timeCell);

      // 勤務欄 (3 + 11 = 14)
      for (let j = 0; j < 14; j++) {
        let td = document.createElement("td");
        td.className = "droppable";
        td.dataset.time = timeLabel;
        tr.appendChild(td);
      }

      tbody.appendChild(tr);
    }

    // 生成 15 行 × 3 欄 → 人員
    let totalPeople = 45;
    let colCount = 3;
    let rowCount = 15;
    for (let row = 0; row < rowCount; row++) {
      for (let col = 0; col < colCount; col++) {
        let idx = row + col * rowCount + 1; // 縱向遞增
        if (idx <= totalPeople) {
          let div = document.createElement("div");
          div.className = "person";
          div.textContent = "人員" + idx;
          div.dataset.name = "人員" + idx;
          personGrid.appendChild(div);
        }
      }
    }

    // 點擊切換亮/暗 + 排序
    function updateOrder() {
      let activePersons = [...document.querySelectorAll(".person.active")];
      activePersons.forEach((p, idx) => {
        p.textContent = p.dataset.name + " (" + (idx + 1) + ")";
      });
      document.querySelectorAll(".person:not(.active)").forEach(p => {
        p.textContent = p.dataset.name;
      });
    }

    document.querySelectorAll(".person").forEach(p => {
      p.addEventListener("click", () => {
        p.classList.toggle("active");
        updateOrder();
      });
    });

    // 產生卡片
    function createCard(name) {
      let card = document.createElement("div");
      card.className = "card";
      card.textContent = name;
      card.draggable = true;

      card.addEventListener("dragstart", e => {
        e.dataTransfer.setData("text/plain", name);
        e.dataTransfer.setData("sourceId", card.parentElement.dataset.cellId || "");
      });

      return card;
    }

    // 設定表格可放卡片
    function makeDroppable(cell) {
      cell.dataset.cellId = Math.random().toString(36).substr(2, 9);
      cell.addEventListener("dragover", e => {
        e.preventDefault();
        cell.classList.add("highlight");
      });
      cell.addEventListener("dragleave", () => {
        cell.classList.remove("highlight");
      });
      cell.addEventListener("drop", e => {
        e.preventDefault();
        cell.classList.remove("highlight");

        let name = e.dataTransfer.getData("text/plain");
        let sourceId = e.dataTransfer.getData("sourceId");

        // 如果來自其他 cell，移除舊位置
        if (sourceId) {
          let sourceCell = document.querySelector(`[data-cell-id="${sourceId}"]`);
          if (sourceCell) {
            let card = [...sourceCell.querySelectorAll(".card")].find(c => c.textContent === name);
            if (card) card.remove();
          }
        }

        // 放到新格子
        cell.appendChild(createCard(name));
      });
    }

    document.querySelectorAll(".droppable").forEach(makeDroppable);

    // 自動排備勤
    document.getElementById("autoAssign").addEventListener("click", () => {
      let activePersons = [...document.querySelectorAll(".person.active")];
      if (activePersons.length > 11) {
        alert("⚠️ 啟用人員超過 11 位，無法自動排備勤！");
        return;
      }

      let personnel = activePersons.map((p, idx) => ({
        name: p.dataset.name,
        order: idx + 1
      }));

      // 清空所有備欄
      document.querySelectorAll("#schedule tbody tr").forEach(tr => {
        let cells = tr.querySelectorAll("td");
        for (let j = 4; j < cells.length; j++) {
          cells[j].innerHTML = "";
        }
      });

      // 按照規則填入
      document.querySelectorAll("#schedule tbody tr").forEach((tr, rowIndex) => {
        let cells = tr.querySelectorAll("td");

        // 每 2 小時順位往後移
        let shift = Math.floor(rowIndex / 2);

        personnel.forEach((p, idx) => {
          let newIndex = (idx + shift) % personnel.length;
          let targetCell = cells[4 + idx]; // 勤務A/B/C 後第 idx+1 個
          targetCell.appendChild(createCard(personnel[newIndex].name));
        });
      });
    });
  </script>
</body>
</html>
